# MorningAI 架構視覺化圖表

## 1. 系統全景架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              User Layer                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐                    ┌──────────────────────┐       │
│  │   Platform Owner     │                    │   Tenant Users       │       │
│  │  (admin.morningai)   │                    │  (app.morningai)     │       │
│  └──────────┬───────────┘                    └──────────┬───────────┘       │
│             │                                            │                   │
└─────────────┼────────────────────────────────────────────┼───────────────────┘
              │                                            │
              │                                            │
┌─────────────┼────────────────────────────────────────────┼───────────────────┐
│             │         Frontend Layer (Vercel)            │                   │
├─────────────┼────────────────────────────────────────────┼───────────────────┤
│             │                                            │                   │
│  ┌──────────▼───────────┐                    ┌──────────▼───────────┐       │
│  │  Owner Console       │                    │ Tenant Dashboard     │       │
│  │  ┌────────────────┐  │                    │  ┌────────────────┐  │       │
│  │  │ Vite + React   │  │                    │  │ Vite + React   │  │       │
│  │  │ TypeScript     │  │                    │  │ TypeScript     │  │       │
│  │  │ Tailwind CSS   │  │                    │  │ Tailwind CSS   │  │       │
│  │  │ Tolgee i18n    │  │                    │  │ i18next        │  │       │
│  │  └────────────────┘  │                    │  │ Supabase Auth  │  │       │
│  │                      │                    │  └────────────────┘  │       │
│  │  Features:           │                    │                      │       │
│  │  • Agent Governance  │                    │  Features:           │       │
│  │  • Tenant Mgmt       │                    │  • Strategy Mgmt     │       │
│  │  • System Monitor    │                    │  • Approvals         │       │
│  │  • Platform Settings │                    │  • Cost Dashboard    │       │
│  └──────────┬───────────┘                    │  • Global Search     │       │
│             │                                 │  • Undo/Redo         │       │
│             │                                 └──────────┬───────────┘       │
│             │                                            │                   │
└─────────────┼────────────────────────────────────────────┼───────────────────┘
              │                                            │
              └────────────────┬───────────────────────────┘
                               │
                               │ HTTPS/REST API
                               │
┌──────────────────────────────▼─────────────────────────────────────────────┐
│                      Backend Layer (Render)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    FastAPI Backend                                  │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │                    API Routes                                 │  │    │
│  │  │  /api/governance/*  /api/tenants/*  /api/strategies/*        │  │    │
│  │  │  /api/agent/*       /api/user/*     /healthz                 │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │                    Middleware                                 │  │    │
│  │  │  • JWT Authentication                                         │  │    │
│  │  │  • RBAC Authorization                                         │  │    │
│  │  │  • Rate Limiting (Redis)                                      │  │    │
│  │  │  • CORS                                                       │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌──────────────────────────────────────────────────────────────┐  │    │
│  │  │                    Services                                   │  │    │
│  │  │  • Agent Orchestrator Client                                  │  │    │
│  │  │  • Cost Tracking                                              │  │    │
│  │  │  • Reputation Engine                                          │  │    │
│  │  │  • Audit Logger                                               │  │    │
│  │  └──────────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────┬───────────────────────────────┬─────────────────────┘
                       │                               │
                       │                               │
┌──────────────────────▼───────────────┐   ┌───────────▼─────────────────────┐
│   Data & State Layer                 │   │  Agent Orchestration Layer      │
├──────────────────────────────────────┤   ├─────────────────────────────────┤
│                                      │   │                                 │
│  ┌────────────────────────────────┐ │   │  ┌───────────────────────────┐ │
│  │   Supabase PostgreSQL          │ │   │  │   LangGraph Orchestrator  │ │
│  │   ┌──────────────────────────┐ │ │   │  │   ┌─────────────────────┐ │ │
│  │   │ Multi-tenant Tables      │ │ │   │  │   │  State Machine      │ │ │
│  │   │ • tenants                │ │ │   │  │   │  ┌────────────────┐ │ │ │
│  │   │ • users                  │ │ │   │  │   │  │ Planner        │ │ │ │
│  │   │ • strategies             │ │ │   │  │   │  │ ↓              │ │ │ │
│  │   │ • decisions              │ │ │   │  │   │  │ Executor       │ │ │ │
│  │   │ • costs                  │ │ │   │  │   │  │ ↓              │ │ │ │
│  │   │ • audit_logs             │ │ │   │  │   │  │ CI Monitor     │ │ │ │
│  │   └──────────────────────────┘ │ │   │  │   │  │ ↓              │ │ │ │
│  │   ┌──────────────────────────┐ │ │   │  │   │  │ Fixer          │ │ │ │
│  │   │ pgvector Extension       │ │ │   │  │   │  │ ↓              │ │ │ │
│  │   │ • embeddings             │ │ │   │  │   │  │ Finalizer      │ │ │ │
│  │   │ • semantic search        │ │ │   │  │   │  └────────────────┘ │ │ │
│  │   └──────────────────────────┘ │ │   │  │   └─────────────────────┘ │ │
│  │   ┌──────────────────────────┐ │ │   │  │                           │ │
│  │   │ RLS Policies             │ │ │   │  │   Integrations:           │ │
│  │   │ • tenant_isolation       │ │ │   │  │   • GitHub API            │ │
│  │   │ • owner_access           │ │ │   │  │   • OpenAI API            │ │
│  │   │ • authenticated_access   │ │ │   │  │   • Sentry                │ │
│  │   └──────────────────────────┘ │ │   │  └───────────────────────────┘ │
│  └────────────────────────────────┘ │   │                                 │
│                                      │   │  ┌───────────────────────────┐ │
│  ┌────────────────────────────────┐ │   │  │   Agent Sandboxes         │ │
│  │   Upstash Redis                │ │   │  │   (Fly.io)                │ │
│  │   ┌──────────────────────────┐ │ │   │  │                           │ │
│  │   │ Session State            │ │ │   │  │  ┌─────────────────────┐ │ │
│  │   │ Rate Limiting            │ │ │   │  │  │ Dev_Agent           │ │ │
│  │   │ Task Queues (RQ)         │ │ │   │  │  │ • VSCode Server     │ │ │
│  │   │ API Response Cache       │ │ │   │  │  │ • LSP               │ │ │
│  │   └──────────────────────────┘ │ │   │  │  │ • Git               │ │ │
│  └────────────────────────────────┘ │   │  │  └─────────────────────┘ │ │
│                                      │   │  │                           │ │
└──────────────────────────────────────┘   │  │  ┌─────────────────────┐ │ │
                                            │  │  │ Ops_Agent           │ │ │
                                            │  │  │ • Shell access      │ │ │
                                            │  │  │ • Browser           │ │ │
                                            │  │  │ • Render API        │ │ │
                                            │  │  └─────────────────────┘ │ │
                                            │  └───────────────────────────┘ │
                                            └─────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      External Integrations                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   GitHub     │  │   OpenAI     │  │   Sentry     │  │   Vercel     │   │
│  │   API        │  │   API        │  │   Monitoring │  │   Previews   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 資料流架構圖

### 2.1 使用者認證流程

```
┌──────────────┐
│   User       │
│  (Browser)   │
└──────┬───────┘
       │ 1. Login request
       │    (email + password)
       ▼
┌──────────────────────────────────┐
│   Frontend (Dashboard)           │
│   ┌────────────────────────────┐ │
│   │  Supabase Auth Client      │ │
│   │  supabase.auth.signIn()    │ │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 2. Auth request
                 ▼
┌──────────────────────────────────┐
│   Supabase Auth Service          │
│   ┌────────────────────────────┐ │
│   │  Verify credentials        │ │
│   │  Generate JWT token        │ │
│   │  Set RLS context           │ │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 3. JWT token
                 │    {sub, role, tenant_id}
                 ▼
┌──────────────────────────────────┐
│   Frontend (Dashboard)           │
│   ┌────────────────────────────┐ │
│   │  Store token in localStorage│ │
│   │  Set Authorization header  │ │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 4. API request
                 │    Authorization: Bearer <JWT>
                 ▼
┌──────────────────────────────────┐
│   Backend (FastAPI)              │
│   ┌────────────────────────────┐ │
│   │  JWT Middleware            │ │
│   │  • Verify signature        │ │
│   │  • Extract claims          │ │
│   │  • Set request.user        │ │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 5. Database query
                 │    SET app.current_tenant_id = <tenant_id>
                 ▼
┌──────────────────────────────────┐
│   Supabase PostgreSQL            │
│   ┌────────────────────────────┐ │
│   │  RLS Policy Check          │ │
│   │  WHERE tenant_id =         │ │
│   │    current_setting(...)    │ │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 6. Filtered data
                 ▼
┌──────────────────────────────────┐
│   Backend (FastAPI)              │
│   └────────────┬───────────────┘ │
└────────────────┼──────────────────┘
                 │ 7. JSON response
                 ▼
┌──────────────────────────────────┐
│   Frontend (Dashboard)           │
│   • Render UI                    │
└──────────────────────────────────┘
```

### 2.2 Agent 執行流程

```
┌──────────────┐
│   User       │
│  (Dashboard) │
└──────┬───────┘
       │ 1. Create strategy
       │    {name, description, trigger}
       ▼
┌──────────────────────────────────┐
│   Frontend API Call              │
│   POST /api/strategies           │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│   Backend (FastAPI)              │
│   • Validate request             │
│   • Store in database            │
│   • Return strategy_id           │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│   User triggers execution        │
│   POST /api/agent/execute        │
│   {strategy_id}                  │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────────────────────────────┐
│   Backend (FastAPI)                                       │
│   ┌────────────────────────────────────────────────────┐ │
│   │  1. Load strategy from database                    │ │
│   │  2. Create execution record (status: pending)      │ │
│   │  3. Send to orchestrator                           │ │
│   └────────────────────────┬───────────────────────────┘ │
└────────────────────────────┼──────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│   LangGraph Orchestrator                                     │
│   ┌───────────────────────────────────────────────────────┐ │
│   │  State Machine Execution                              │ │
│   │                                                        │ │
│   │  ┌──────────┐                                         │ │
│   │  │ Planner  │  GPT-4: Break down strategy into tasks │ │
│   │  └────┬─────┘                                         │ │
│   │       │                                                │ │
│   │       ▼                                                │ │
│   │  ┌──────────┐                                         │ │
│   │  │ Executor │  Route tasks to appropriate agents     │ │
│   │  └────┬─────┘                                         │ │
│   │       │                                                │ │
│   │       ├─────────────┬─────────────┐                   │ │
│   │       ▼             ▼             ▼                   │ │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │ │
│   │  │Dev_Agent│  │Ops_Agent│  │PM_Agent │              │ │
│   │  │(Fly.io) │  │(Fly.io) │  │(Future) │              │ │
│   │  └────┬────┘  └────┬────┘  └────┬────┘              │ │
│   │       │            │            │                     │ │
│   │       │ Execute    │ Monitor    │ Plan                │ │
│   │       │ code fix   │ logs       │ sprint              │ │
│   │       │            │            │                     │ │
│   │       └────────────┴────────────┘                     │ │
│   │                    │                                   │ │
│   │                    ▼                                   │ │
│   │  ┌──────────────────────────┐                         │ │
│   │  │ CI Monitor               │                         │ │
│   │  │ • Watch GitHub Actions   │                         │ │
│   │  │ • Detect failures        │                         │ │
│   │  └────┬─────────────────────┘                         │ │
│   │       │                                                │ │
│   │       ▼                                                │ │
│   │  ┌──────────┐                                         │ │
│   │  │  Fixer   │  Auto-fix CI failures                  │ │
│   │  └────┬─────┘                                         │ │
│   │       │                                                │ │
│   │       ▼                                                │ │
│   │  ┌──────────┐                                         │ │
│   │  │Finalizer │  Generate report, update costs         │ │
│   │  └────┬─────┘                                         │ │
│   └───────┼────────────────────────────────────────────────┘ │
└───────────┼──────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────┐
│   Backend (FastAPI)                                          │
│   • Update execution record (status: completed)              │
│   • Store cost data                                          │
│   • Update reputation scores                                 │
│   • Create audit log                                         │
└────────────┬────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│   Frontend (Dashboard)                                       │
│   • WebSocket notification (real-time update)                │
│   • Refresh execution history                                │
│   • Display results                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 部署架構圖

### 3.1 當前部署 (Phase 8)

```
                        ┌─────────────────────┐
                        │  Cloudflare DNS     │
                        │  • app.morningai    │
                        │  • admin.morningai  │
                        └──────────┬──────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼──────────┐       ┌─────────▼──────────┐
         │   Vercel (US-East)  │       │  Vercel (US-East)  │
         │  ┌───────────────┐  │       │  ┌───────────────┐ │
         │  │   Dashboard   │  │       │  │Owner Console  │ │
         │  │   (React)     │  │       │  │   (React)     │ │
         │  └───────────────┘  │       │  └───────────────┘ │
         │  • Edge CDN         │       │  • Edge CDN        │
         │  • Auto-deploy      │       │  • Auto-deploy     │
         │  • Preview PRs      │       │  • Preview PRs     │
         └──────────┬──────────┘       └─────────┬──────────┘
                    │                            │
                    └──────────────┬─────────────┘
                                   │
                        ┌──────────▼──────────┐
                        │  Render (US-East)   │
                        │  ┌───────────────┐  │
                        │  │   FastAPI     │  │
                        │  │   Backend     │  │
                        │  └───────────────┘  │
                        │  • 512MB RAM        │
                        │  • 1 instance       │
                        │  • Manual deploy    │
                        └──────────┬──────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
┌────────▼────────┐    ┌───────────▼──────────┐    ┌────────▼────────┐
│  Supabase       │    │  Upstash Redis       │    │  Fly.io         │
│  (US-East)      │    │  (Global)            │    │  (US-East)      │
│  ┌───────────┐  │    │  ┌────────────────┐  │    │  ┌───────────┐  │
│  │PostgreSQL │  │    │  │  Session State │  │    │  │Dev_Agent  │  │
│  │+ pgvector │  │    │  │  Rate Limiting │  │    │  │(Sandbox)  │  │
│  │+ RLS      │  │    │  │  Task Queue    │  │    │  └───────────┘  │
│  └───────────┘  │    │  │  Cache         │  │    │  ┌───────────┐  │
│  • Free tier    │    │  └────────────────┘  │    │  │Ops_Agent  │  │
│  • 500MB DB     │    │  • Free tier         │    │  │(Sandbox)  │  │
│  • 2GB storage  │    │  • 10K req/day       │    │  └───────────┘  │
└─────────────────┘    └──────────────────────┘    │  • Auto-scale   │
                                                    │  • $2/mo each   │
                                                    └─────────────────┘

External Services:
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   GitHub     │  │   OpenAI     │  │   Sentry     │
│   API        │  │   API        │  │   Monitoring │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 3.2 目標部署 (Q2 2026)

```
                        ┌─────────────────────┐
                        │  Cloudflare         │
                        │  • Global CDN       │
                        │  • WAF              │
                        │  • DDoS Protection  │
                        └──────────┬──────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼──────────┐       ┌─────────▼──────────┐
         │   Vercel (Global)   │       │  Vercel (Global)   │
         │  • Multi-region     │       │  • Multi-region    │
         │  • Edge functions   │       │  • Edge functions  │
         └──────────┬──────────┘       └─────────┬──────────┘
                    │                            │
                    └──────────────┬─────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
┌────────▼────────┐    ┌───────────▼──────────┐    ┌────────▼────────┐
│  Render         │    │  Render              │    │  Render         │
│  (US-East)      │    │  (EU-West)           │    │  (APAC)         │
│  ┌───────────┐  │    │  ┌────────────────┐  │    │  ┌───────────┐  │
│  │ Backend   │  │    │  │   Backend      │  │    │  │ Backend   │  │
│  │ 3 inst.   │  │    │  │   3 inst.      │  │    │  │ 3 inst.   │  │
│  └───────────┘  │    │  └────────────────┘  │    │  └───────────┘  │
│  • Auto-scale   │    │  • Auto-scale        │    │  • Auto-scale   │
│  • Load balance │    │  • Load balance      │    │  • Load balance │
└────────┬────────┘    └───────────┬──────────┘    └────────┬────────┘
         │                         │                         │
         └─────────────────────────┼─────────────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
┌────────▼────────┐    ┌───────────▼──────────┐    ┌────────▼────────┐
│  Supabase       │    │  Upstash Redis       │    │  Fly.io         │
│  (Multi-region) │    │  (Multi-region)      │    │  (Multi-region) │
│  ┌───────────┐  │    │  ┌────────────────┐  │    │  ┌───────────┐  │
│  │Primary    │  │    │  │  Global cache  │  │    │  │Agent Pool │  │
│  │(US-East)  │  │    │  │  Replication   │  │    │  │10 inst.   │  │
│  └─────┬─────┘  │    │  └────────────────┘  │    │  └───────────┘  │
│  ┌─────▼─────┐  │    │  • Paid tier         │    │  • Auto-scale   │
│  │Read       │  │    │  • 1M req/day        │    │  • $50/mo       │
│  │Replicas   │  │    └──────────────────────┘    └─────────────────┘
│  │(EU, APAC) │  │
│  └───────────┘  │    ┌──────────────────────┐
│  • Paid tier    │    │  Datadog APM         │
│  • Connection   │    │  • Metrics           │
│  │  pooling    │    │  • Traces            │
└─────────────────┘    │  • Logs              │
                       └──────────────────────┘
```

---

## 4. CI/CD Pipeline 架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Developer Workflow                               │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ git push
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         GitHub Repository                                │
│                         (RC918/morningai)                                │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼──────────┐       ┌─────────▼──────────┐
         │   PR Branch         │       │   Main Branch      │
         └──────────┬──────────┘       └─────────┬──────────┘
                    │                            │
                    │                            │
┌───────────────────▼────────────────────────────▼───────────────────────┐
│                    GitHub Actions (28 Workflows)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Phase 1: Code Quality (Parallel)                              │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │   Lint       │  │  Typecheck   │  │  Format      │         │    │
│  │  │  • ESLint    │  │  • tsc       │  │  • Prettier  │         │    │
│  │  │  • Ruff      │  │  • mypy      │  │              │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Phase 2: Testing (Parallel)                                   │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Unit Tests  │  │  Integration │  │  E2E Tests   │         │    │
│  │  │  • pytest    │  │  • pytest    │  │  • Playwright│         │    │
│  │  │  • vitest    │  │  • API tests │  │              │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Phase 3: Security (Parallel)                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Gitleaks    │  │  TruffleHog  │  │  Dependency  │         │    │
│  │  │  • Secrets   │  │  • Verified  │  │  • Snyk      │         │    │
│  │  │  • Patterns  │  │  • Secrets   │  │  • Audit     │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Phase 4: Build (Parallel)                                     │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Dashboard   │  │Owner Console │  │  Backend     │         │    │
│  │  │  • Vite      │  │  • Vite      │  │  • Docker    │         │    │
│  │  │  • Build     │  │  • Build     │  │  • Image     │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Phase 5: Governance                                           │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  PR Guard    │  │  OpenAPI     │  │  Env Schema  │         │    │
│  │  │  • Rules     │  │  • Validate  │  │  • Validate  │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└──────────────────────────────────┬───────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼──────────┐       ┌─────────▼──────────┐
         │   PR: Preview       │       │   Main: Deploy     │
         │   ┌──────────────┐  │       │   ┌──────────────┐ │
         │   │  Vercel      │  │       │   │  Vercel      │ │
         │   │  Preview     │  │       │   │  Production  │ │
         │   │  Deploy      │  │       │   │  Deploy      │ │
         │   └──────────────┘  │       │   └──────────────┘ │
         │   • Comment PR      │       │   • Auto-deploy    │
         │   • Test URL        │       │   • Health check   │
         └─────────────────────┘       └─────────┬──────────┘
                                                  │
                                                  ▼
                                       ┌─────────────────────┐
                                       │  Post-Deploy        │
                                       │  ┌───────────────┐  │
                                       │  │  Health Check │  │
                                       │  │  Smoke Tests  │  │
                                       │  │  Sentry       │  │
                                       │  └───────────────┘  │
                                       └─────────────────────┘
```

---

## 5. 安全架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Security Layers                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Layer 1: Network Security                                              │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  • Cloudflare WAF (Web Application Firewall)                   │    │
│  │  • DDoS Protection                                              │    │
│  │  • SSL/TLS Encryption (HTTPS only)                             │    │
│  │  • Rate Limiting (10 req/min per IP)                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  Layer 2: Application Security                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Authentication (JWT)                                     │  │    │
│  │  │  ┌────────────────────────────────────────────────────┐  │  │    │
│  │  │  │  Token Structure:                                   │  │  │    │
│  │  │  │  {                                                  │  │  │    │
│  │  │  │    "sub": "user_id",                                │  │  │    │
│  │  │  │    "role": "owner|admin|user",                      │  │  │    │
│  │  │  │    "tenant_id": "uuid",                             │  │  │    │
│  │  │  │    "permissions": ["read:*", "write:*"],            │  │  │    │
│  │  │  │    "exp": 1234567890                                │  │  │    │
│  │  │  │  }                                                  │  │  │    │
│  │  │  └────────────────────────────────────────────────────┘  │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Authorization (RBAC)                                     │  │    │
│  │  │  ┌────────────────────────────────────────────────────┐  │  │    │
│  │  │  │  Role Hierarchy:                                    │  │  │    │
│  │  │  │                                                     │  │  │    │
│  │  │  │  Owner (Platform Admin)                            │  │  │    │
│  │  │  │    ├─ Full platform access                         │  │  │    │
│  │  │  │    ├─ Manage all tenants                           │  │  │    │
│  │  │  │    └─ System configuration                         │  │  │    │
│  │  │  │                                                     │  │  │    │
│  │  │  │  Admin (Tenant Admin)                              │  │  │    │
│  │  │  │    ├─ Manage tenant users                          │  │  │    │
│  │  │  │    ├─ View all tenant data                         │  │  │    │
│  │  │  │    └─ Configure tenant settings                    │  │  │    │
│  │  │  │                                                     │  │  │    │
│  │  │  │  User (Standard User)                              │  │  │    │
│  │  │  │    ├─ Own data only                                │  │  │    │
│  │  │  │    ├─ Create strategies                            │  │  │    │
│  │  │  │    └─ View own history                             │  │  │    │
│  │  │  └────────────────────────────────────────────────────┘  │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  Layer 3: Data Security (Row Level Security)                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  PostgreSQL RLS Policies                                        │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Policy 1: Tenant Isolation                              │  │    │
│  │  │  CREATE POLICY tenant_isolation ON <table>               │  │    │
│  │  │    FOR ALL                                               │  │    │
│  │  │    USING (                                               │  │    │
│  │  │      tenant_id = current_setting(                        │  │    │
│  │  │        'app.current_tenant_id'                           │  │    │
│  │  │      )::uuid                                             │  │    │
│  │  │    );                                                    │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Policy 2: Owner Bypass                                  │  │    │
│  │  │  CREATE POLICY owner_access ON <table>                   │  │    │
│  │  │    FOR ALL                                               │  │    │
│  │  │    USING (                                               │  │    │
│  │  │      current_setting('app.current_role') = 'owner'       │  │    │
│  │  │      OR tenant_id = current_setting(...)::uuid           │  │    │
│  │  │    );                                                    │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Policy 3: Authenticated Access                          │  │    │
│  │  │  CREATE POLICY authenticated_access ON <table>           │  │    │
│  │  │    FOR SELECT                                            │  │    │
│  │  │    USING (                                               │  │    │
│  │  │      auth.uid() IS NOT NULL                              │  │    │
│  │  │      AND tenant_id = current_setting(...)::uuid          │  │    │
│  │  │    );                                                    │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  Layer 4: Secret Management                                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  • GitHub Secrets (CI/CD)                                       │    │
│  │  • Environment Variables (Runtime)                              │    │
│  │  • Gitleaks + TruffleHog (Secret Scanning)                      │    │
│  │  • .env files (Local dev only, gitignored)                      │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  Layer 5: Audit & Compliance                                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  • Audit Logs (All actions logged)                              │    │
│  │  • Sentry Monitoring (Error tracking)                           │    │
│  │  • Access Logs (Request logging)                                │    │
│  │  • Compliance Reports (SOC2, GDPR)                              │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 成本架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Cost Breakdown (Monthly)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Current (Phase 8): $11-46/month                                        │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                                                                 │    │
│  │  Frontend (Vercel)                                              │    │
│  │  ├─ Dashboard: $0/month (Hobby)                                │    │
│  │  └─ Owner Console: $0/month (Hobby)                            │    │
│  │                                                                 │    │
│  │  Backend (Render)                                               │    │
│  │  └─ 512MB instance: $7/month                                   │    │
│  │                                                                 │    │
│  │  Database (Supabase)                                            │    │
│  │  └─ Free tier: $0/month (or $25 if paid)                       │    │
│  │                                                                 │    │
│  │  Cache (Upstash Redis)                                          │    │
│  │  └─ Free tier: $0/month (or $10 if paid)                       │    │
│  │                                                                 │    │
│  │  Agents (Fly.io)                                                │    │
│  │  ├─ Dev_Agent: $2/month                                         │    │
│  │  └─ Ops_Agent: $2/month                                         │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Target (Q2 2026): ~$509/month                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                                                                 │    │
│  │  Frontend (Vercel)                                              │    │
│  │  ├─ Dashboard: $20/month (Pro)                                 │    │
│  │  └─ Owner Console: $20/month (Pro)                             │    │
│  │                                                                 │    │
│  │  Backend (Render)                                               │    │
│  │  ├─ US-East (3 instances): $63/month                           │    │
│  │  ├─ EU-West (3 instances): $63/month                           │    │
│  │  └─ APAC (3 instances): $63/month                              │    │
│  │                                                                 │    │
│  │  Database (Supabase)                                            │    │
│  │  └─ Multi-region: $100/month                                   │    │
│  │                                                                 │    │
│  │  Cache (Upstash Redis)                                          │    │
│  │  └─ Multi-region: $50/month                                    │    │
│  │                                                                 │    │
│  │  Agents (Fly.io)                                                │    │
│  │  └─ Agent pool (10 instances): $50/month                       │    │
│  │                                                                 │    │
│  │  CDN (Cloudflare)                                               │    │
│  │  └─ Pro plan: $20/month                                        │    │
│  │                                                                 │    │
│  │  Monitoring (Datadog)                                           │    │
│  │  └─ APM + Logs: $100/month                                     │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Revenue Model:                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Target MRR: $10,000+                                           │    │
│  │  ├─ 20 enterprise customers @ $500/month                        │    │
│  │  └─ 100 SMB customers @ $50/month (future)                      │    │
│  │                                                                 │    │
│  │  Gross Margin: ~95%                                             │    │
│  │  ├─ Revenue: $10,000/month                                      │    │
│  │  ├─ Infrastructure: $509/month                                  │    │
│  │  └─ Profit: $9,491/month                                        │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 監控架構圖 (目標)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Monitoring Stack                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Metrics Collection (Prometheus)                                │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  System      │  │  Application │  │  Business    │         │    │
│  │  │  • CPU       │  │  • Latency   │  │  • MRR       │         │    │
│  │  │  • Memory    │  │  • Throughput│  │  • Users     │         │    │
│  │  │  • Disk      │  │  • Errors    │  │  • Executions│         │    │
│  │  │  • Network   │  │  • Cache hit │  │  • Costs     │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Visualization (Grafana)                                        │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  System      │  │  API         │  │  Agent       │         │    │
│  │  │  Health      │  │  Performance │  │  Performance │         │    │
│  │  │  Dashboard   │  │  Dashboard   │  │  Dashboard   │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  │  ┌──────────────┐  ┌──────────────┐                           │    │
│  │  │  Business    │  │  Cost        │                           │    │
│  │  │  Metrics     │  │  Analysis    │                           │    │
│  │  └──────────────┘  └──────────────┘                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Logging (CloudWatch / Datadog)                                 │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Application │  │  Access      │  │  Audit       │         │    │
│  │  │  Logs        │  │  Logs        │  │  Logs        │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  APM (Datadog)                                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Distributed │  │  Performance │  │  Error       │         │    │
│  │  │  Tracing     │  │  Profiling   │  │  Tracking    │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Alerting (PagerDuty + Slack)                                   │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │    │
│  │  │  Critical    │  │  Warning     │  │  Info        │         │    │
│  │  │  • P0        │  │  • P1        │  │  • P2        │         │    │
│  │  │  • Page      │  │  • Slack     │  │  • Slack     │         │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

**文檔版本**: v1.0  
**最後更新**: 2025-10-24  
**維護者**: Devin AI

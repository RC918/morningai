# Test Coverage Next Batch: 80% Target

## æ¦‚è¿°
è¦åŠƒä¸‹ä¸€æ‰¹æ¸¬è©¦è¦†è“‹ç‡æ”¹é€²ï¼Œç›®æ¨™å¾ç•¶å‰ 75.65% æå‡è‡³ 80%+ã€‚

**ç•¶å‰ç‹€æ…‹**: 75.65% (654 tests)  
**ç›®æ¨™**: 80%+ (é ä¼°éœ€è¦ ~50-70 å€‹æ–°æ¸¬è©¦)  
**é è¨ˆæ™‚ç¨‹**: 2-3 å€‹å·¥ä½œæ—¥  
**å‰ç½® PR**: #723 (å·²åˆä½µ), #731 (coverage gate)

## ç•¶å‰è¦†è“‹ç‡åˆ†æ

### ä½è¦†è“‹ç‡æª”æ¡ˆï¼ˆå„ªå…ˆè™•ç†ï¼‰

#### 1. governance.py - **35% è¦†è“‹ç‡** ğŸ”´
**ç•¶å‰ç‹€æ…‹**:
- ç¸½è¡Œæ•¸: 136 lines
- å·²è¦†è“‹: 48 lines
- æœªè¦†è“‹: 88 lines

**æœªè¦†è“‹çš„é—œéµåŠŸèƒ½**:
- é¢¨éšªè·¯ç”±æ±ºç­–é‚è¼¯ï¼ˆhigh/medium/low risk routingï¼‰
- å¤šç§Ÿæˆ¶ç­–ç•¥è¡çªè™•ç†
- Policy ç¹¼æ‰¿å’Œè¦†å¯«æ©Ÿåˆ¶
- å‹•æ…‹ç­–ç•¥é‡è¼‰
- éŒ¯èª¤é™ç´šè·¯å¾‘ï¼ˆpolicy å¤±æ•—æ™‚çš„ fallbackï¼‰

**æ¸¬è©¦è¨ˆç•«** (é ä¼° 20-25 å€‹æ¸¬è©¦):
1. **é¢¨éšªè·¯ç”±æ¸¬è©¦** (8 tests):
   - High risk â†’ human review è·¯ç”±
   - Medium risk â†’ enhanced monitoring è·¯ç”±
   - Low risk â†’ auto-approve è·¯ç”±
   - é‚Šç•Œæ¢ä»¶ï¼ˆrisk score è‡¨ç•Œå€¼ï¼‰
   - å¤šé‡é¢¨éšªå› å­çµ„åˆ
   - é¢¨éšªè©•åˆ†è¨ˆç®—æ­£ç¢ºæ€§
   - é¢¨éšªç­‰ç´šå‡é™ç´š
   - è‡ªå®šç¾©é¢¨éšªé–¾å€¼

2. **å¤šç§Ÿæˆ¶ç­–ç•¥æ¸¬è©¦** (6 tests):
   - ç§Ÿæˆ¶ A ç­–ç•¥ä¸å½±éŸ¿ç§Ÿæˆ¶ B
   - ç§Ÿæˆ¶ç­–ç•¥ç¹¼æ‰¿ global policy
   - ç§Ÿæˆ¶ç­–ç•¥è¦†å¯« global policy
   - ç§Ÿæˆ¶ç­–ç•¥è¡çªè§£æ±º
   - è·¨ç§Ÿæˆ¶æ¬Šé™éš”é›¢
   - ç§Ÿæˆ¶ç­–ç•¥å‹•æ…‹åˆ‡æ›

3. **Policy åŠ è¼‰å’Œé‡è¼‰æ¸¬è©¦** (4 tests):
   - å‹•æ…‹é‡è¼‰ policyï¼ˆç„¡éœ€é‡å•Ÿï¼‰
   - Policy ç‰ˆæœ¬æ§åˆ¶
   - Policy å›æ»¾æ©Ÿåˆ¶
   - Policy ç†±æ›´æ–°é€šçŸ¥

4. **éŒ¯èª¤è™•ç†å’Œé™ç´šæ¸¬è©¦** (4 tests):
   - Policy è§£æå¤±æ•— â†’ ä½¿ç”¨ default policy
   - Policy åŸ·è¡Œè¶…æ™‚ â†’ fail-safe mode
   - ç„¡æ•ˆ policy â†’ è¨˜éŒ„éŒ¯èª¤ä¸¦ä½¿ç”¨ fallback
   - Policy service ä¸å¯ç”¨ â†’ æœ¬åœ° cache

5. **å·¥å…·æ¬Šé™çŸ©é™£æ¸¬è©¦** (3 tests):
   - è¤‡é›œæ¬Šé™çµ„åˆï¼ˆå¤šå€‹å·¥å…·ã€å¤šå€‹è§’è‰²ï¼‰
   - æ¬Šé™ç¹¼æ‰¿éˆ
   - æ¬Šé™æ’¤éŠ·å’Œæ¢å¾©

**é æœŸè¦†è“‹ç‡æå‡**: 35% â†’ 70%+ (å¢åŠ  35%)

#### 2. main.py - **65% è¦†è“‹ç‡** ğŸŸ¡
**ç•¶å‰ç‹€æ…‹**:
- ç¸½è¡Œæ•¸: 603 lines
- å·²è¦†è“‹: 389 lines
- æœªè¦†è“‹: 214 lines

**æœªè¦†è“‹çš„é—œéµåŠŸèƒ½**:
- å¤–éƒ¨ä¾è³´å¤±æ•—é‡è©¦é‚è¼¯
- é™ç´šè·¯å¾‘ï¼ˆgraceful degradationï¼‰
- è¤‡é›œéŒ¯èª¤è™•ç†éˆ
- ä¸­é–“ä»¶çµ„åˆå’Œé †åº
- è«‹æ±‚/éŸ¿æ‡‰è½‰æ›

**æ¸¬è©¦è¨ˆç•«** (é ä¼° 15-20 å€‹æ¸¬è©¦):
1. **å¤–éƒ¨ä¾è³´é‡è©¦æ¸¬è©¦** (5 tests):
   - Supabase é€£æ¥å¤±æ•— â†’ é‡è©¦ 3 æ¬¡
   - LLM API è¶…æ™‚ â†’ exponential backoff
   - Redis æš«æ™‚ä¸å¯ç”¨ â†’ è·³é cache
   - ç¬¬ä¸‰æ–¹ API rate limit â†’ ç­‰å¾…ä¸¦é‡è©¦
   - æ‰€æœ‰é‡è©¦å¤±æ•— â†’ è¿”å›é™ç´šéŸ¿æ‡‰

2. **é™ç´šè·¯å¾‘æ¸¬è©¦** (4 tests):
   - FAQ æœå°‹å¤±æ•— â†’ è¿”å› cached results
   - Agent ä¸å¯ç”¨ â†’ è¿”å›éœæ…‹å›æ‡‰
   - å‘é‡æœå°‹å¤±æ•— â†’ fallback åˆ°é—œéµå­—æœå°‹
   - å®Œå…¨é™ç´šæ¨¡å¼ï¼ˆæ‰€æœ‰å¤–éƒ¨ä¾è³´å¤±æ•—ï¼‰

3. **ä¸­é–“ä»¶æ¸¬è©¦** (4 tests):
   - ä¸­é–“ä»¶åŸ·è¡Œé †åºæ­£ç¢ºæ€§
   - ä¸­é–“ä»¶ç•°å¸¸ä¸å½±éŸ¿å…¶ä»–ä¸­é–“ä»¶
   - ä¸­é–“ä»¶ä¿®æ”¹ request/response
   - ä¸­é–“ä»¶çŸ­è·¯ï¼ˆearly returnï¼‰

4. **è¤‡é›œéŒ¯èª¤è™•ç†æ¸¬è©¦** (4 tests):
   - åµŒå¥—éŒ¯èª¤è™•ç†ï¼ˆerror in error handlerï¼‰
   - éŒ¯èª¤ä¸Šä¸‹æ–‡ä¿ç•™
   - éŒ¯èª¤èšåˆå’Œå ±å‘Š
   - è‡ªå®šç¾©éŒ¯èª¤é¡å‹è™•ç†

5. **è«‹æ±‚/éŸ¿æ‡‰è½‰æ›æ¸¬è©¦** (3 tests):
   - è«‹æ±‚åƒæ•¸é©—è­‰å’Œè½‰æ›
   - éŸ¿æ‡‰æ ¼å¼æ¨™æº–åŒ–
   - åœ‹éš›åŒ–ï¼ˆi18nï¼‰éŸ¿æ‡‰

**é æœŸè¦†è“‹ç‡æå‡**: 65% â†’ 78%+ (å¢åŠ  13%)

#### 3. agent.py - **70% è¦†è“‹ç‡** ğŸŸ¡
**ç•¶å‰ç‹€æ…‹**:
- ç¸½è¡Œæ•¸: 163 lines
- å·²è¦†è“‹: 114 lines
- æœªè¦†è“‹: 49 lines

**æœªè¦†è“‹çš„é—œéµåŠŸèƒ½**:
- è¤‡é›œä»»å‹™ç·¨æ’
- ä¸¦ç™¼ä»»å‹™è™•ç†
- ä»»å‹™å„ªå…ˆç´šå’Œæ’ç¨‹
- é•·æ™‚é–“é‹è¡Œä»»å‹™ç›£æ§

**æ¸¬è©¦è¨ˆç•«** (é ä¼° 10-12 å€‹æ¸¬è©¦):
1. **ä»»å‹™ç·¨æ’æ¸¬è©¦** (4 tests):
   - å¤šæ­¥é©Ÿä»»å‹™åŸ·è¡Œé †åº
   - ä»»å‹™ä¾è³´é—œä¿‚è™•ç†
   - ä»»å‹™å¤±æ•—å›æ»¾
   - æ¢ä»¶åˆ†æ”¯ä»»å‹™

2. **ä¸¦ç™¼è™•ç†æ¸¬è©¦** (3 tests):
   - å¤šå€‹ä¸¦ç™¼ä»»å‹™ä¸äº’ç›¸å¹²æ“¾
   - ä¸¦ç™¼é™åˆ¶ï¼ˆmax concurrent tasksï¼‰
   - ä»»å‹™ä½‡åˆ—æ»¿æ™‚çš„è™•ç†

3. **ä»»å‹™ç›£æ§æ¸¬è©¦** (3 tests):
   - é•·æ™‚é–“é‹è¡Œä»»å‹™é€²åº¦è¿½è¹¤
   - ä»»å‹™è¶…æ™‚æª¢æ¸¬å’Œçµ‚æ­¢
   - ä»»å‹™è³‡æºä½¿ç”¨ç›£æ§

4. **ä»»å‹™å„ªå…ˆç´šæ¸¬è©¦** (2 tests):
   - é«˜å„ªå…ˆç´šä»»å‹™å„ªå…ˆåŸ·è¡Œ
   - å„ªå…ˆç´šå‹•æ…‹èª¿æ•´

**é æœŸè¦†è“‹ç‡æå‡**: 70% â†’ 82%+ (å¢åŠ  12%)

### ä¸­ç­‰è¦†è“‹ç‡æª”æ¡ˆï¼ˆæ¬¡è¦å„ªå…ˆï¼‰

#### 4. faq.py - **79% è¦†è“‹ç‡** âœ…
**ç•¶å‰ç‹€æ…‹**: å·²ç¶“ç›¸ç•¶å¥½ï¼Œå¯ä»¥æš«ç·©

#### 5. auth_middleware.py - **68% è¦†è“‹ç‡** ğŸŸ¡
**æ¸¬è©¦è¨ˆç•«** (é ä¼° 5-8 å€‹æ¸¬è©¦):
- Token åˆ·æ–°æ©Ÿåˆ¶
- å¤šç¨®èªè­‰æ–¹å¼ï¼ˆJWT, API Key, OAuthï¼‰
- èªè­‰å¤±æ•—å¾Œçš„é‡è©¦
- èªè­‰ cache æ©Ÿåˆ¶

**é æœŸè¦†è“‹ç‡æå‡**: 68% â†’ 80%+ (å¢åŠ  12%)

## FAQ E2E æ¸¬è©¦æ•´åˆ

### ç›®æ¨™
å°‡ FAQ åŠŸèƒ½ç´å…¥ fast-pass æ¸¬è©¦çŸ©é™£ï¼Œç¢ºä¿ç«¯åˆ°ç«¯æµç¨‹æ­£å¸¸ã€‚

### æ¸¬è©¦å ´æ™¯ (é ä¼° 8-10 å€‹ E2E æ¸¬è©¦):

1. **å®Œæ•´ FAQ ç”Ÿå‘½é€±æœŸ** (1 test):
   - å‰µå»º FAQ â†’ æœå°‹ FAQ â†’ æ›´æ–° FAQ â†’ åˆªé™¤ FAQ
   - é©—è­‰æ¯ä¸€æ­¥çš„éŸ¿æ‡‰å’Œå‰¯ä½œç”¨

2. **FAQ æœå°‹æµç¨‹** (3 tests):
   - é—œéµå­—æœå°‹ â†’ å‘é‡æœå°‹ â†’ çµæœæ’åº â†’ åˆ†é 
   - ç©ºæœå°‹çµæœè™•ç†
   - æœå°‹çµæœ cache é©—è­‰

3. **FAQ æ¬Šé™æµç¨‹** (2 tests):
   - User è§’è‰²ï¼šåªèƒ½æœå°‹
   - Admin è§’è‰²ï¼šå®Œæ•´ CRUD æ¬Šé™

4. **FAQ èˆ‡ Agent æ•´åˆ** (2 tests):
   - Agent æŸ¥è©¢ FAQ ä¸¦å›ç­”ç”¨æˆ¶
   - Agent å»ºè­°æ–° FAQï¼ˆåŸºæ–¼å¸¸è¦‹å•é¡Œï¼‰

5. **FAQ æ€§èƒ½æ¸¬è©¦** (2 tests):
   - å¤§é‡ FAQ æœå°‹æ€§èƒ½
   - ä¸¦ç™¼æœå°‹è«‹æ±‚è™•ç†

### Fast-Pass çŸ©é™£é…ç½®
```yaml
# .github/workflows/e2e-fast-pass.yml
on:
  pull_request:
    paths:
      - 'handoff/**/api-backend/src/routes/faq.py'
      - 'handoff/**/api-backend/src/routes/agent.py'
      - 'handoff/**/api-backend/tests/test_faq_*.py'
      - 'handoff/**/api-backend/tests/test_agent_*.py'

jobs:
  faq-e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Run FAQ E2E tests
        run: |
          pytest tests/e2e/test_faq_lifecycle.py -v
```

## å¯¦æ–½è¨ˆç•«

### Phase 1: Governance æ·±åº¦è¦†è“‹ï¼ˆDay 1-2ï¼‰
**ç›®æ¨™**: governance.py å¾ 35% â†’ 70%+

**æ­¥é©Ÿ**:
1. å‰µå»º `test_governance_risk_routing.py` (8 tests)
2. å‰µå»º `test_governance_multi_tenant.py` (6 tests)
3. å‰µå»º `test_governance_policy_reload.py` (4 tests)
4. æ“´å±• `test_governance_authz.py` (7 tests â†’ 11 tests)
5. é‹è¡Œæ¸¬è©¦ä¸¦é©—è­‰è¦†è“‹ç‡

**é©—æ”¶æ¨™æº–**:
- governance.py è¦†è“‹ç‡ â‰¥ 70%
- æ‰€æœ‰æ–°æ¸¬è©¦é€šé
- ç„¡ flaky tests

### Phase 2: Main & Agent éŒ¯èª¤è™•ç†ï¼ˆDay 2-3ï¼‰
**ç›®æ¨™**: main.py 65% â†’ 78%, agent.py 70% â†’ 82%

**æ­¥é©Ÿ**:
1. å‰µå»º `test_main_retry_degradation.py` (15 tests)
2. å‰µå»º `test_agent_orchestration.py` (10 tests)
3. æ“´å±• `test_agent_error_paths.py` (17 tests â†’ 25 tests)
4. é‹è¡Œæ¸¬è©¦ä¸¦é©—è­‰è¦†è“‹ç‡

**é©—æ”¶æ¨™æº–**:
- main.py è¦†è“‹ç‡ â‰¥ 78%
- agent.py è¦†è“‹ç‡ â‰¥ 82%
- æ‰€æœ‰æ–°æ¸¬è©¦é€šé

### Phase 3: FAQ E2E æ•´åˆï¼ˆDay 3ï¼‰
**ç›®æ¨™**: å»ºç«‹ E2E æ¸¬è©¦æ¡†æ¶

**æ­¥é©Ÿ**:
1. å‰µå»º `tests/e2e/` ç›®éŒ„çµæ§‹
2. å‰µå»º `test_faq_lifecycle.py` (10 tests)
3. é…ç½® fast-pass workflow
4. é‹è¡Œ E2E æ¸¬è©¦ä¸¦é©—è­‰

**é©—æ”¶æ¨™æº–**:
- æ‰€æœ‰ E2E æ¸¬è©¦é€šé
- Fast-pass é…ç½®æ­£ç¢º
- E2E æ¸¬è©¦æ™‚é–“ < 2 åˆ†é˜

### Phase 4: æœ€çµ‚é©—è­‰å’Œ PRï¼ˆDay 3ï¼‰
**æ­¥é©Ÿ**:
1. é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
2. é©—è­‰ç¸½è¦†è“‹ç‡ â‰¥ 80%
3. æª¢æŸ¥ CI é€šé
4. å‰µå»º PR ä¸¦ç­‰å¾…å¯©æŸ¥

**é©—æ”¶æ¨™æº–**:
- ç¸½è¦†è“‹ç‡ â‰¥ 80%
- æ‰€æœ‰æ¸¬è©¦é€šéï¼ˆé ä¼° 700+ testsï¼‰
- CI coverage gate é€šéï¼ˆâ‰¥ 75%ï¼‰
- ç„¡ flaky tests

## é æœŸæˆæœ

### è¦†è“‹ç‡æå‡
- **governance.py**: 35% â†’ 70% (+35%)
- **main.py**: 65% â†’ 78% (+13%)
- **agent.py**: 70% â†’ 82% (+12%)
- **auth_middleware.py**: 68% â†’ 80% (+12%)
- **ç¸½è¦†è“‹ç‡**: 75.65% â†’ 80%+ (+4.35%)

### æ¸¬è©¦æ•¸é‡
- **ç•¶å‰**: 654 tests
- **æ–°å¢**: ~60 tests
- **ç¸½è¨ˆ**: ~714 tests

### æ¸¬è©¦åŸ·è¡Œæ™‚é–“
- **ç•¶å‰**: ~30 ç§’ï¼ˆunit testsï¼‰
- **æ–°å¢**: ~10 ç§’ï¼ˆunit testsï¼‰+ ~2 åˆ†é˜ï¼ˆE2E testsï¼‰
- **ç¸½è¨ˆ**: ~2.5 åˆ†é˜

## é¢¨éšªå’Œç·©è§£

### é¢¨éšª 1: æ¸¬è©¦éæ–¼è¤‡é›œ
**ç·©è§£**: 
- ä½¿ç”¨ fixtures å’Œ helper functions ç°¡åŒ–æ¸¬è©¦
- éµå¾ª AAA æ¨¡å¼ï¼ˆArrange, Act, Assertï¼‰
- æ¯å€‹æ¸¬è©¦åªé©—è­‰ä¸€å€‹è¡Œç‚º

### é¢¨éšª 2: Flaky tests
**ç·©è§£**:
- é¿å…ä¾è³´å¤–éƒ¨æœå‹™ï¼ˆä½¿ç”¨ mocksï¼‰
- é¿å…æ™‚é–“ä¾è³´ï¼ˆä½¿ç”¨ freezegunï¼‰
- ä½¿ç”¨ pytest-xdist ä¸¦è¡Œé‹è¡Œæª¢æ¸¬ç«¶æ…‹æ¢ä»¶

### é¢¨éšª 3: æ¸¬è©¦ç¶­è­·æˆæœ¬é«˜
**ç·©è§£**:
- ä½¿ç”¨ parametrize æ¸›å°‘é‡è¤‡ä»£ç¢¼
- å»ºç«‹å…±äº« fixtures åº«
- æ–‡æª”åŒ–æ¸¬è©¦æ„åœ–å’Œå ´æ™¯

### é¢¨éšª 4: CI æ™‚é–“éé•·
**ç·©è§£**:
- ä½¿ç”¨ pytest-xdist ä¸¦è¡Œé‹è¡Œ
- åˆ†é›¢ unit tests å’Œ E2E tests
- åªåœ¨ç›¸é—œæª”æ¡ˆè®Šæ›´æ™‚é‹è¡Œ E2E testsï¼ˆfast-passï¼‰

## æˆåŠŸæŒ‡æ¨™

### é‡åŒ–æŒ‡æ¨™
- âœ… ç¸½è¦†è“‹ç‡ â‰¥ 80%
- âœ… governance.py â‰¥ 70%
- âœ… main.py â‰¥ 78%
- âœ… agent.py â‰¥ 82%
- âœ… æ‰€æœ‰æ¸¬è©¦é€šéç‡ 100%
- âœ… CI åŸ·è¡Œæ™‚é–“ < 5 åˆ†é˜

### è³ªåŒ–æŒ‡æ¨™
- âœ… æ¸¬è©¦å¯è®€æ€§é«˜ï¼ˆæ¸…æ™°çš„æ¸¬è©¦åç¨±å’Œçµæ§‹ï¼‰
- âœ… æ¸¬è©¦ç©©å®šæ€§é«˜ï¼ˆç„¡ flaky testsï¼‰
- âœ… æ¸¬è©¦ç¶­è­·æ€§å¥½ï¼ˆæ˜“æ–¼ä¿®æ”¹å’Œæ“´å±•ï¼‰
- âœ… æ¸¬è©¦è¦†è“‹é—œéµæ¥­å‹™é‚è¼¯

## åƒè€ƒè³‡æ–™
- [PR #723: Test Coverage Batch A/B/C](https://github.com/RC918/morningai/pull/723)
- [PR #731: Coverage Gate 75%](https://github.com/RC918/morningai/pull/731)
- [TEST_COVERAGE_IMPROVEMENT_REPORT.md](./TEST_COVERAGE_IMPROVEMENT_REPORT.md)
- [POST_DEPLOYMENT_MONITORING_24H.md](./POST_DEPLOYMENT_MONITORING_24H.md)

## è¯çµ¡äºº
- **æŠ€è¡“è² è²¬äºº**: Ryan Chen (@RC918)
- **Devin Session**: https://app.devin.ai/sessions/438417371dcc4d1f95886422404511ea

name: Weekly Sentry Smoke Test

on:
  schedule:
    - cron: '0 12 * * 1'
  workflow_dispatch:

jobs:
  sentry-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Sentry SDK
        run: pip install sentry-sdk==2.19.2
      
      - name: Validate required secrets
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_ORG_SLUG: ${{ secrets.SENTRY_ORG_SLUG }}
        run: |
          python - <<EOF
          import os
          import sys
          
          missing = []
          dsn = os.getenv('SENTRY_DSN')
          org_slug = os.getenv('SENTRY_ORG_SLUG')
          
          if not dsn or not dsn.strip():
              missing.append('SENTRY_DSN')
          if not org_slug or not org_slug.strip():
              missing.append('SENTRY_ORG_SLUG')
          
          if missing:
              print(f"âŒ Missing required secrets: {', '.join(missing)}")
              print("Please configure these secrets in GitHub repository settings.")
              sys.exit(1)
          
          print("âœ… All required secrets are configured")
          print(f"   SENTRY_ORG_SLUG: {org_slug}")
          EOF
      
      - name: Send Sentry smoke test message
        id: smoke_test
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          python - <<EOF
          import sentry_sdk
          import os
          import sys
          
          dsn = os.getenv('SENTRY_DSN')
          
          try:
              sentry_sdk.init(dsn=dsn, traces_sample_rate=1.0)
              
              event_id = sentry_sdk.capture_message("weekly smoke test", level="info")
              sentry_sdk.flush(timeout=5)
              
              if not event_id:
                  print("âŒ Sentry event_id is None - message may not have been sent")
                  sys.exit(1)
              
              print(f"âœ… Weekly Sentry smoke test message sent successfully")
              print(f"Event ID: {event_id}")
          except Exception as e:
              print(f"âŒ Sentry smoke test failed: {e}")
              sys.exit(1)
          EOF
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Weekly Sentry Smoke Test Failed',
              body: `## Sentry Smoke Test Failure
            
            The weekly Sentry smoke test has failed.
            
            **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Triggered**: ${new Date().toISOString()}
            
            ### Possible Causes
            - SENTRY_DSN or SENTRY_ORG_SLUG secrets not configured or invalid
            - Sentry API connectivity issues
            - Sentry SDK initialization failure
            
            ### Action Required
            1. Check the workflow logs for detailed error messages
            2. Verify Sentry secrets are correctly configured
            3. Test Sentry connectivity manually if needed
            
            cc @oncall`,
              labels: ['bug', 'sentry', 'monitoring']
            };
            
            await github.rest.issues.create(issue);

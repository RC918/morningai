name: env-diagnose
on: { workflow_dispatch: {} }
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install Redis client
        run: pip install redis
      - name: Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: 'curl -sS "$SUPABASE_URL/rest/v1/" -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" | head -n 1'
      - name: Redis (tcp)
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          python - <<'PY'
          import os, sys, redis
          redis_url = os.environ.get('REDIS_URL', '')
          if not redis_url:
              print('⚠️  REDIS_URL not configured in GitHub secrets')
              print('ℹ️  To add: Settings → Secrets and variables → Actions → New repository secret')
              sys.exit(0)
          try:
              r = redis.from_url(redis_url)
              result = r.ping()
              print(f'✅ Redis PING: {result}')
          except Exception as e:
              print(f'❌ Redis connection failed: {e}')
              sys.exit(1)
          PY
      - name: Redis (rest)
        env:
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        run: |
          if [ -z "$UPSTASH_REDIS_REST_URL" ] || [ -z "$UPSTASH_REDIS_REST_TOKEN" ]; then
            echo "⚠️  Upstash Redis REST credentials not configured"
            exit 0
          fi
          curl -sS "$UPSTASH_REDIS_REST_URL/ping" -H "Authorization: Bearer $UPSTASH_REDIS_REST_TOKEN" -H "Content-Type: application/json" | head -n 1
      - name: Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ZONE_ID" ]; then
            echo "⚠️  Cloudflare credentials not configured"
            exit 0
          fi
          curl -sS "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/dns_records?per_page=1" -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" | head -n 1
      - name: Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ]; then
            echo "⚠️  Vercel credentials not configured"
            exit 0
          fi
          npx -y vercel@latest projects ls --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" | head -n 1
      - name: Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "⚠️  Render API key not configured"
            exit 0
          fi
          curl -sS https://api.render.com/v1/services -H "Authorization: Bearer $RENDER_API_KEY" | head -n 1
      - name: Sentry
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          if [ -z "$SENTRY_DSN" ]; then
            echo "⚠️  Sentry DSN not configured"
            exit 0
          fi
          echo "✅ Sentry DSN configured: ${SENTRY_DSN:0:30}..."




# Morning AI - 雲端 Staging 驗收規範與四件組流程

**版本**: 2.0 (終極整合版)
**日期**: 2025-09-12
**作者**: Manus AI

---

## 1. **核心原則：雲端優先 (Cloud-First)**

為了根除「在我電腦上可以跑」(It works on my machine) 的傳統軟體開發頑疾，Morning AI 項目**強制推行「雲端優先」原則**。所有開發、測試、整合、驗收的最終標準，均以在**雲端 Staging 環境**的實際運行結果為唯一依據。

- **本地開發僅供調試**: 開發者可以在本地進行功能開發和單元測試。
- **PR 觸發自動部署**: 任何提交到 GitHub 的 Pull Request 都會自動觸發部署到一個獨立的預覽環境 (Preview Environment)。
- **合併到 `main` 觸發 Staging 部署**: 一旦 PR 被合併到 `main` 分支，將自動部署到統一的 Staging 環境。
- **Staging 是唯一驗收標準**: 所有階段性的功能驗收、E2E 測試和性能評估，都必須在 Staging 環境進行。

## 2. **項目階段劃分與雲端驗收**

項目將分為五個核心階段完成，每個階段的結束都意味著一次正式的、基於 Staging 環境的交付和驗收。

### **階段一：基礎設施與核心框架 (D+0 ~ D+14)**
- **目標**: 搭建完整的雲端基礎設施和 CI/CD 流程，為後續開發鋪平道路。
- **雲端交付物**:
    - 可運行的 Staging 環境 URL (`https://staging.api.morningai.me`)。
    - 完整的 Terraform 代碼，用於一鍵部署所有基礎設施。
    - 可執行的 GitHub Actions workflow，包含完整的「四件組」自動化檢核。
- **驗收標準**: 在 GitHub Actions 中，針對 Staging 環境的「四件組」檢核流程**首次完全通過 (全綠)**。

### **階段二：核心租戶與 AI 綁定 (D+15 ~ D+30)**
- **目標**: 實現用戶註冊、多租戶管理和創新的 AI Agent 輔助平台綁定功能。
- **雲端交付物**:
    - 可在 Staging 環境完成註冊、登錄、創建租戶的完整流程。
    - 可在 Staging 環境通過對話式 AI Agent 完成至少一個平台（如 Telegram）的綁定。
- **驗收標準**: 針對 Staging 環境的 E2E 測試（使用 Playwright）覆蓋用戶註冊和平台綁定流程，測試通過率 100%。CI/CD 中的「四件組」檢核持續通過。

### **階段三：AI Bot 客製化與金流 (D+31 ~ D+50)**
- **目標**: 實現 AI Bot 生成器、知識庫管理和對接 Stripe 的訂閱金流功能。
- **雲端交付物**:
    - 可在 Staging 環境創建並客製化一個 AI Bot。
    - 可在 Staging 環境通過 Stripe 的測試模式完成一次完整的訂閱支付流程。
- **驗收標準**: 針對 Staging 環境的 E2E 測試覆蓋 Bot 創建和支付流程，測試通過率 100%。CI/CD 中的「四件組」檢核持續通過。

### **階段四：AI 自治系統核心 (D+51 ~ D+75)**
- **目標**: 實現 AI 任務編排 (Orchestrator)、Meta-Agent 決策中樞和 AI 治理主控台。
- **雲端交付物**:
    - 可在 Staging 環境的治理主控台中，查看到由 Meta-Agent 發起並成功執行的跨 Agent 任務日誌。
- **驗收標準**: 在 Staging 環境成功觸發並驗證一個完整的自主決策與執行流程（例如：監控到性能下降 → Meta-Agent 提案 → Ops-Agent 執行擴容）。CI/CD 中的「四件組」檢核持續通過。

### **階段五：數據智能與成長 (D+76 ~ D+90)**
- **目標**: 建立數據儀表板、行銷成長模組和對外 API 中心。
- **雲端交付物**:
    - 可在 Staging 環境訪問嵌入的 QuickSight 數據儀表板，並看到（模擬的）業務數據。
    - 可在 Staging 環境調用對外開放的 API，並獲取正確響應。
- **驗收標準**: 儀表板數據展示正確，API 端點符合 OpenAPI 規範。CI/CD 中的「四件組」檢核持續通過，準備 Production 部署。

## 3. **「四件組」自動化檢核流程詳解**

「四件組」是嵌入在 GitHub Actions CI/CD 流程中的**強制性、自動化**的質量門禁。任何試圖合併到 `main` 分支的代碼，都必須 100% 通過以下四個階段的檢核。

### **檢核一：`/health` 端點存活檢查 (Liveness Probe)**
- **目的**: 快速確認服務容器已成功啟動並響應網絡請求。
- **實現**: CI 流程使用 `curl` 或類似工具請求 Staging API 的 `/health` 端點。
- **通過標準**: HTTP 狀態碼必須為 `200 OK`。
- **規範**: 此端點**必須**是輕量級的，**不得**連接數據庫或任何外部依賴，以確保其能快速、穩定地反映服務本身的運行狀態。

### **檢核二：API 連通性與數據庫健康檢查 (Readiness Probe)**
- **目的**: 驗證服務不僅已啟動，而且其依賴的關鍵服務（如數據庫）也已準備就緒，服務可以開始處理真實流量。
- **實現**: CI 流程請求一個專門的 `/healthz` 端點。
- **通過標準**: HTTP 狀態碼為 `200 OK`，且響應體中 `{"status": "ok"}`。
- **規範**: `/healthz` 端點的實現**必須**包含對以下組件的連通性檢查：
    - 主數據庫 (PostgreSQL)
    - 緩存 (Redis)
    - 任何其他關鍵的後端服務
- 如果任何依賴項失敗，`/healthz` 應返回 `200 OK` 但響應體為 `{"status": "degraded", "dependencies": {"database": "failed"}}`，CI 流程會將此視為失敗。

### **檢核三：數據庫三表基礎驗證 (DB Sanity Check)**
- **目的**: 確保數據庫遷移 (Migration) 和種子數據 (Seed) 已成功執行，系統具備運行的最基礎數據。
- **實現**: CI 流程執行一個腳本，該腳本連接到 Staging 數據庫並執行三條 `SELECT COUNT(*)` 查詢。
- **通過標準**: 以下三個條件必須同時滿足：
    - `SELECT COUNT(*) FROM tenants` 必須 `> 0`。
    - `SELECT COUNT(*) FROM users` 必須 `> 0`。
    - `SELECT COUNT(*) FROM ai_agents` 必須 `> 0`。
- **重要性**: 這是防止因遷移失敗或種子數據缺失導致整個應用程序功能異常的關鍵防線。

### **檢核四：負載與回退模擬 (Resilience Check)**
- **目的**: 驗證系統具備基本的性能承載能力和故障恢復能力。
- **實現**:
    - **負載測試**: CI 流程使用 `k6` 腳本，對 Staging API 的幾個核心端點發起 30 秒的低強度負載測試（例如，10 個虛擬用戶）。
    - **回退模擬**: CI 流程觸發一次對 Fargate 服務的更新，但故意使用一個無效的 Docker 鏡像標籤。然後輪詢服務狀態，直到檢測到部署已自動回滾到上一個穩定版本。
- **通過標準**:
    - 負載測試期間，API 的 P95 延遲必須低於 500ms，且錯誤率為 0%。
    - 回退模擬必須在 5 分鐘內完成，服務最終恢復到健康狀態。

## 4. **結論**

通過強制執行「雲端 Staging 驗收」和「四件組自動化檢核」，Morning AI 項目建立了一套現代化的、高度可靠的質量保障體系。這套體系將開發者的責任從「寫完代碼」延伸到了「確保代碼在類生產環境中穩定、高效地運行」，從根本上提升了交付質量，降低了生產環境的風險，是實現敏捷開發和持續交付的核心工程文化的核心工程實踐。

